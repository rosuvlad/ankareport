<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>AnkaReport Dev Server</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="ankareport.css" />
    <link rel="stylesheet" href="style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.12.3/ace.js"></script>
    <script src="ankareport.js"></script>
    <script src="layout.js"></script>
    <script src="data-source.js"></script>
    <script src="data.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="content">
        <div id="designer"></div>

        <div class="export-buttons">
          <input
            id="export-to-pdf-button"
            type="button"
            value="Export To Pdf"
            onclick="exportToPdf()"
          />
          <input
            id="export-to-xlsx-button"
            type="button"
            value="Export To Xlsx"
            onclick="exportToXlsx()"
          />
        </div>

        <div id="report"></div>
      </div>

      <div id="right-panel" class="right-panel">
        <div class="tabs">
          <button class="panel-toggle-btn" onclick="toggleRightPanel()">â˜°</button>
          <button class="tab-btn active" data-tab="layout" onclick="switchTab('layout')">Layout</button>
          <button class="tab-btn" data-tab="data-source" onclick="switchTab('data-source')">Data Source</button>
          <button class="tab-btn" data-tab="data" onclick="switchTab('data')">Data</button>
        </div>
        <div class="tab-content">
          <div id="layout-tab" class="tab-pane active">
            <div class="tab-toolbar">
              <input
                id="load-layout-from-designer"
                type="button"
                value="Load From Designer"
                onclick="loadLayoutFromDesigner()"
              />
              <input
                id="switch-layout"
                type="button"
                value="Show Report"
                onclick="switchLayout()"
              />
            </div>
            <div id="layout-editor"></div>
          </div>
          <div id="data-source-tab" class="tab-pane">
            <div id="data-source-editor"></div>
          </div>
          <div id="data-tab" class="tab-pane">
            <div id="data-editor"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log("AnkaReport Version: " + AnkaReport.version);
      document.title = `AnkaReport ${AnkaReport.version}-dev`;

      var page = 1;
      var designer = null;

      const designerDiv = document.getElementById("designer");
      const rendererDiv = document.getElementById("report");

      const loadLayoutFromDesignerButton = document.getElementById(
        "load-layout-from-designer",
      );
      const switchLayoutButton = document.getElementById("switch-layout");
      const rightPanel = document.getElementById("right-panel");
      const exportToPdfButton = document.getElementById("export-to-pdf-button");
      const exportToXlsxButton = document.getElementById("export-to-xlsx-button");

      const layoutEditor = ace.edit("layout-editor");
      layoutEditor.session.setMode("ace/mode/json");
      layoutEditor.setValue(JSON.stringify(layout, null, 2), 1);

      const dataSourceEditor = ace.edit("data-source-editor");
      dataSourceEditor.session.setMode("ace/mode/json");
      dataSourceEditor.setValue(JSON.stringify(dataSource, null, 2), 1);

      const dataEditor = ace.edit("data-editor");
      dataEditor.session.setMode("ace/mode/json");
      dataEditor.setValue(JSON.stringify(data, null, 2), 1);

      const refreshDesigner = () => {
        try {
          const layout = JSON.parse(layoutEditor.getValue());
          const dataSource = JSON.parse(dataSourceEditor.getValue());

          designerDiv.innerHTML = "";

          designer = AnkaReport.designer({
            element: designerDiv,
            dataSource,
            layout,
            onSaveButtonClick: (layout) => {
              console.log(layout);
            },
          });
        } catch {}
      };

      let renderer = null;

      const refreshReport = () => {
        try {
          const layout = JSON.parse(layoutEditor.getValue());
          const data = JSON.parse(dataEditor.getValue());

          rendererDiv.innerHTML = "";

          renderer = AnkaReport.render({
            element: rendererDiv,
            layout,
            data,
          });

          // Update export button visibility based on supportedOutputs (only in report view)
          if (page === 1) {
            updateExportButtons(layout.supportedOutputs);
          }
        } catch (e) {
          // Only log non-JSON parse errors (ignore incomplete JSON while typing)
          if (!(e instanceof SyntaxError)) {
            console.error("Error refreshing report:", e);
          }
        }
      };

      const updateExportButtons = (supportedOutputs) => {
        const outputs = supportedOutputs || "PDF_AND_EXCEL";
        const showPdf = outputs === "PDF_AND_EXCEL" || outputs === "PDF";
        const showExcel = outputs === "PDF_AND_EXCEL" || outputs === "EXCEL";
        
        exportToPdfButton.style.display = showPdf ? null : "none";
        exportToXlsxButton.style.display = showExcel ? null : "none";
      };

      layoutEditor.on("change", () => {
        refreshDesigner();
        refreshReport();
      });
      dataSourceEditor.on("change", () => refreshDesigner());
      dataEditor.on("change", () => refreshReport());

      refreshDesigner();
      refreshReport();

      const exportToPdf = async () => {
        if (!renderer) {
          console.error("Renderer not initialized");
          return;
        }
        try {
          await renderer.exportToPdf("report.pdf");
        } catch (e) {
          console.error("Error exporting to PDF:", e);
        }
      };

      const exportToXlsx = async () => {
        if (!renderer) {
          console.error("Renderer not initialized");
          return;
        }
        try {
          await renderer.exportToXlsx("report.xlsx");
        } catch (e) {
          console.error("Error exporting to XLSX:", e);
        }
      };

      const showDesigner = () => {
        page = 0;
        switchLayoutButton.value = "Show Report";
        designerDiv.style.display = null;
        rendererDiv.style.display = "none";
        loadLayoutFromDesignerButton.style.display = null;
        exportToPdfButton.style.display = "none";
        exportToXlsxButton.style.display = "none";
      };

      const showReport = () => {
        page = 1;
        switchLayoutButton.value = "Show Designer";
        designerDiv.style.display = "none";
        rendererDiv.style.display = null;
        loadLayoutFromDesignerButton.style.display = "none";
        // Show export buttons based on supportedOutputs
        try {
          const layout = JSON.parse(layoutEditor.getValue());
          updateExportButtons(layout.supportedOutputs);
        } catch {
          // Default to showing both if layout can't be parsed
          exportToPdfButton.style.display = null;
          exportToXlsxButton.style.display = null;
        }
      };

      showDesigner();

      const switchLayout = () => {
        switch (page) {
          case 0:
            showReport();
            break;
          case 1:
            showDesigner();
            break;
        }
      };

      const loadLayoutFromDesigner = () => {
        const layout = designer.toJSON();
        layoutEditor.setValue(JSON.stringify(layout, null, 2), 1);
      };

      const switchTab = (tabName) => {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
        
        // Update tab panes
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
      };

      const toggleRightPanel = () => {
        const panel = rightPanel;
        if (panel.classList.contains('collapsed')) {
          panel.classList.remove('collapsed');
        } else {
          panel.classList.add('collapsed');
        }
      };
    </script>
  </body>
</html>
